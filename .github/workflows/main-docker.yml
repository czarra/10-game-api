# .github/workflows/master-docker.yml
name: 'Build, Push and Deploy to Production'

on:
  workflow_dispatch:

jobs:
  lint:
    name: 'Lint'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Set up PHP'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: gd, zip, pdo, pdo_pgsql, opcache
          tools: composer, phpstan

      - name: 'Cache Composer dependencies'
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: 'Install dependencies'
        run: composer install --prefer-dist --no-progress --no-suggest
        env:
          APP_ENV: test
          DATABASE_URL: 'sqlite:///%kernel.project_dir%/var/data.db'

      - name: 'Run PHPStan'
        run: phpstan analyse

  unit-tests:
    name: 'Unit Tests'
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Set up PHP'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: gd, zip, pdo, pdo_pgsql, opcache
          tools: composer

      - name: 'Cache Composer dependencies'
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: 'Install dependencies'
        run: composer install --prefer-dist --no-progress --no-suggest
        env:
          APP_ENV: test
          DATABASE_URL: 'sqlite:///%kernel.project_dir%/var/data.db'

      - name: 'Run Unit Tests'
        run: vendor/bin/phpunit --testsuite Unit

  build-and-push:
    name: 'Build and Push Docker Image'
    needs: unit-tests
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Log in to GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 'Extract metadata (tags, labels) for Docker'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/czarra/10-game-api
          tags: |
            type=sha,prefix=,format=short

      - name: 'Build and push Docker image'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./php/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_ENV=prod
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-railway:
    name: 'Deploy to Railway'
    needs: [ build-and-push ]
    runs-on: ubuntu-latest
    steps:
      - name: 'Install Railway CLI'
        run: curl -fsSL https://railway.app/install.sh | sh

      # KROK 1: Tworzymy CZYSTY katalog do deploymentu
      # Dziƒôki temu Railway nie zobaczy Twojego kodu ≈∫r√≥d≈Çowego i nie spr√≥buje go "nadpisaƒá" swoim buildpackiem.
      - name: 'Create isolated Dockerfile'
        run: |
          mkdir deploy_payload
          echo "FROM ghcr.io/czarra/10-game-api:${{ needs.build-and-push.outputs.image_tag }}" > deploy_payload/Dockerfile

      # KROK 2: Wdro≈ºenie z CZYSTEGO katalogu
      # U≈ºywamy working-directory, ≈ºeby railway up wys≈Ça≈Ç TYLKO to, co jest w deploy_payload
      - name: 'Deploy Image to Railway'
        working-directory: ./deploy_payload
        run: railway up --service ${{ secrets.RAILWAY_SERVICE_ID }} --environment production --ci
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # KROK 3: Diagnostyka (Teraz powinno pokazaƒá Twoje pliki!)
      - name: 'üêõ DEBUG: List files structure'
        run: |
          echo "--- Czekam na start kontenera ---"
          sleep 10
          echo "--- LISTING ROOT ---"
          railway run --service ${{ secrets.RAILWAY_SERVICE_ID }} --environment production -- ls -la /var/www/html
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # KROK 4: Komendy bazy danych (≈öcie≈ºka pe≈Çna dla pewno≈õci)
      - name: 'Create database if not exists'
        run: railway run --service ${{ secrets.RAILWAY_SERVICE_ID }} --environment production -- php /var/www/html/bin/console doctrine:database:create --if-not-exists
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: 'Run Migrations'
        run: railway run --service ${{ secrets.RAILWAY_SERVICE_ID }} --environment production -- php /var/www/html/bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}